<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 3: The Storyteller's Toolkit (Final v2)</title>
    <style>
        :root {
            --primary: #6c5ce7;      /* Purple */
            --secondary: #00cec9;    /* Teal */
            --accent: #fdcb6e;       /* Gold */
            --dark: #2d3436;
            --bg: #a29bfe;           /* Light Purple */
            --wrong: #ff7675;
            --correct: #55efc4;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg);
            color: var(--dark);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 850px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            border: 5px solid var(--dark);
        }
        h1 { text-align: center; color: var(--primary); font-size: 2.5em; margin-bottom: 5px; font-family: 'Impact', fantasy; letter-spacing: 2px; }
        h2 { color: var(--dark); border-left: 5px solid var(--accent); padding-left: 15px; margin-top: 40px; }
        p.subtitle { text-align: center; color: #666; font-style: italic; margin-bottom: 30px; }

        /* Navigation */
        .nav-bar { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 30px; }
        .nav-btn {
            background: var(--dark); color: var(--accent); border: none; padding: 10px 20px;
            font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; border-radius: 5px; transition: 0.3s;
        }
        .nav-btn.active { background: var(--primary); color: white; transform: scale(1.1); }
        .section { display: none; animation: fadeIn 0.6s; }
        .section.active { display: block; }

        /* Controls */
        .level-indicator { text-align: right; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: 0.5s; }
        .controls { display: flex; justify-content: space-between; margin-top: 20px; align-items: center; }
        .btn-nav-small { background: #636e72; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .btn-nav-small:disabled { opacity: 0.5; cursor: not-allowed; }
        .check-btn { background: var(--secondary); color: white; border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-size: 1.1em; font-weight:bold; box-shadow: 0 4px 0 #00b894; transition: 0.2s; }
        .check-btn:active { transform: translateY(4px); box-shadow: none; }
        .feedback { text-align: center; font-weight: bold; margin-top: 10px; min-height: 25px; }
        .correct-txt { color: #00b894; } .wrong-txt { color: #d63031; }

        /* Part 1 Styles */
        .grammar-set { display: none; } .grammar-set.active { display: block; animation: slideIn 0.4s; }
        .grammar-box { background: #dfe6e9; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid var(--secondary); font-size: 1.1em; }
        .grammar-input { padding: 5px; font-size: 1em; width: 130px; border: 2px solid #b2bec3; border-radius: 5px; font-family: 'Courier New', monospace; }
        .grammar-input.correct { border-color: var(--correct); background-color: #e3fdf5; } .grammar-input.wrong { border-color: var(--wrong); background-color: #ffeaa7; }

        /* Part 2 Styles */
        .card-container { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .flip-card { background-color: transparent; width: 240px; height: 160px; perspective: 1000px; cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; border-radius: 10px; font-weight: bold; flex-direction: column; }
        .flip-front { background-color: var(--primary); color: white; font-size: 1.2em; }
        .flip-back { background-color: var(--dark); color: var(--accent); transform: rotateY(180deg); font-size: 1em; line-height: 1.4; border: 2px solid var(--accent); }
        .cn-trans { font-size: 0.85em; color: #dfe6e9; margin-top: 8px; font-weight: normal; }

        /* Part 3 Styles */
        .plot-container { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 10px; }
        .plot-row { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
        .plot-row:last-child { border-bottom: none; }
        .plot-select { padding: 8px; border-radius: 5px; border: 2px solid #ccc; font-weight: bold; min-width: 140px; }
        .plot-text-group { display: flex; flex-direction: column; }
        .plot-en { font-weight: bold; color: #2d3436; font-size: 1.05em; }
        .plot-cn { color: #888; font-size: 0.9em; margin-top: 4px; }

        /* Part 4 Styles */
        .mystery-box { text-align: center; background: var(--dark); color: var(--accent); padding: 30px; border-radius: 15px; margin-top: 20px; }
        .slot-machine { display: flex; justify-content: space-around; font-size: 1.2em; font-weight: bold; margin: 20px 0; background: white; color: black; padding: 15px; border-radius: 10px; }
        .spin-btn { background: var(--accent); color: var(--dark); border: none; padding: 15px 40px; font-size: 1.2em; font-weight: bold; border-radius: 50px; cursor: pointer; }
        .spin-btn:hover { background: #e1b12c; }
        #guide-area { background: #f9f9f9; border: 2px dashed var(--primary); padding: 20px; margin-top: 20px; border-radius: 10px; display: none; }
        .guide-step { margin-bottom: 15px; }
        .guide-label { display: block; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .guide-input { width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
        .guide-fixed { background: #eee; padding: 5px 10px; border-radius: 5px; color: #555; font-weight: bold; display: inline-block; margin-bottom: 5px; }
        #final-story-output { background: #fef9e7; padding: 20px; border-radius: 10px; border-left: 5px solid var(--accent); margin-top: 20px; display: none; font-family: 'Courier New', monospace; white-space: pre-wrap; line-height: 1.6; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>üìñ The Storyteller's Toolkit</h1>
    <p class="subtitle">Narrative Writing Master Class</p>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="showSection(1)">1. Grammar</button>
        <button class="nav-btn" onclick="showSection(2)">2. Show Don't Tell</button>
        <button class="nav-btn" onclick="showSection(3)">3. Plot</button>
        <button class="nav-btn" onclick="showSection(4)">4. Story Builder</button>
    </div>

    <div id="section-1" class="section active">
        <h2>‚è≥ 1. The Time Machine</h2>
        <div class="level-indicator">Set <span id="g-level-num">1</span> / 8</div>
        <div class="progress-bar"><div class="progress-fill" id="g-progress-fill"></div></div>
        <div id="grammar-container"></div>
        <div class="controls">
            <button class="btn-nav-small" id="g-prev-btn" onclick="changeGrammarSet(-1)" disabled>‚¨ÖÔ∏è Previous</button>
            <button class="check-btn" id="g-check-btn" onclick="checkGrammarSet()">‚úÖ Check Answers</button>
            <button class="btn-nav-small" id="g-next-btn" onclick="changeGrammarSet(1)" style="visibility:hidden">Next ‚û°Ô∏è</button>
        </div>
        <div id="grammar-feedback" class="feedback"></div>
    </div>

    <div id="section-2" class="section">
        <h2>üé≠ 2. Show, Don't Tell</h2>
        <div class="card-container">
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-front">üò° ANGRY</div><div class="flip-back"><div>"He clenched his fists and his face turned red."</div><div class="cn-trans">‰ªñÊè°Á¥ßÊã≥Â§¥ÔºåËÑ∏Ê∂®ÂæóÈÄöÁ∫¢„ÄÇ</div></div></div></div>
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-front">üò± SCARED</div><div class="flip-back"><div>"Her hands were shaking and her heart beat fast."</div><div class="cn-trans">Â•πÁöÑÊâãÂú®ÂèëÊäñÔºåÂøÉË∑≥Âä†ÈÄü„ÄÇ</div></div></div></div>
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-front">üò¥ TIRED</div><div class="flip-back"><div>"He could barely keep his eyes open."</div><div class="cn-trans">‰ªñÂá†‰πéÁùÅ‰∏çÂºÄÁúºÁùõ„ÄÇ</div></div></div></div>
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-front">üò≤ SHOCKED</div><div class="flip-back"><div>"His jaw dropped and his eyes widened."</div><div class="cn-trans">‰ªñÊÉäÂæóÁõÆÁû™Âè£ÂëÜ„ÄÇ</div></div></div></div>
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-front">üò¢ SAD</div><div class="flip-back"><div>"Tears rolled down her cheeks."</div><div class="cn-trans">Ê≥™Ê∞¥È°∫ÁùÄÂ•πÁöÑËÑ∏È¢äÊµÅ‰∫Ü‰∏ãÊù•„ÄÇ</div></div></div></div>
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-front">üòÅ HAPPY</div><div class="flip-back"><div>"A bright smile lit up her face."</div><div class="cn-trans">ÁÅøÁÉÇÁöÑÁ¨ëÂÆπÁÇπ‰∫Æ‰∫ÜÂ•πÁöÑËÑ∏Â∫û„ÄÇ</div></div></div></div>
        </div>
    </div>

    <div id="section-3" class="section">
        <h2>üé¢ 3. The Story Rollercoaster</h2>
        <div class="level-indicator">Story <span id="p-level-num">1</span> / 8</div>
        <div class="progress-bar"><div class="progress-fill" id="p-progress-fill"></div></div>
        <div id="plot-container" class="plot-container"></div>
        <div class="controls">
            <button class="btn-nav-small" id="p-prev-btn" onclick="changePlotSet(-1)" disabled>‚¨ÖÔ∏è Previous</button>
            <button class="check-btn" id="p-check-btn" onclick="checkPlotSet()">‚úÖ Check Order</button>
            <button class="btn-nav-small" id="p-next-btn" onclick="changePlotSet(1)" style="visibility:hidden">Next Story ‚û°Ô∏è</button>
        </div>
        <div id="plot-feedback" class="feedback"></div>
    </div>

    <div id="section-4" class="section">
        <h2>üé≤ 4. The Guided Story Builder</h2>
        <p style="text-align:center">Step 1: Spin to get your elements. <br>Step 2: Fill in the blanks to build your story.</p>
        
        <div class="mystery-box">
            <div class="slot-machine"><div id="slot-who">‚ùì Character</div><div>+</div><div id="slot-where">‚ùì Setting</div><div>+</div><div id="slot-what">‚ùì Problem</div></div>
            <button class="spin-btn" onclick="spinWheel()">üé∞ SPIN!</button>
        </div>

        <div id="guide-area">
            <h3>üìù Fill in the blanks (Â°´Á©∫):</h3>
            
            <div class="guide-step">
                <span class="guide-label">1. Introduction (Time & Weather)</span>
                <span class="guide-fixed">Last Saturday,</span>
                <input type="text" id="g-weather" class="guide-input" placeholder="e.g. it was a sunny/rainy day (Â§©Ê∞îÂ¶Ç‰Ωï?)...">
            </div>

            <div class="guide-step">
                <span class="guide-label">2. Character & Setting (Generated)</span>
                <span class="guide-fixed" id="g-char-set-text">...</span>
            </div>

            <div class="guide-step">
                <span class="guide-label">3. Action (What were they doing?)</span>
                <span class="guide-fixed">They were busy...</span>
                <input type="text" id="g-action" class="guide-input" placeholder="e.g. taking photos / walking around (Ê≠£Âú®ÂÅö‰ªÄ‰πà?)...">
            </div>

            <div class="guide-step">
                <span class="guide-label">4. The Problem (Generated)</span>
                <span class="guide-fixed">Suddenly,</span>
                <span class="guide-fixed" id="g-prob-text">...</span>
            </div>

            <div class="guide-step">
                <span class="guide-label">5. Reaction (Emotion)</span>
                <span class="guide-fixed">They felt...</span>
                <input type="text" id="g-feeling" class="guide-input" placeholder="e.g. terrified / shocked / worried (ÊÑüËßâÂ¶Ç‰Ωï?)...">
            </div>

            <div class="guide-step">
                <span class="guide-label">6. Resolution (Ending)</span>
                <span class="guide-fixed">In the end,</span>
                <input type="text" id="g-ending" class="guide-input" placeholder="e.g. they ran home / someone helped them (ÁªìÂ±Ä?)...">
            </div>

            <button class="check-btn" style="width:100%" onclick="generateFullStory()">üöÄ Create My Story</button>
        </div>

        <div id="final-story-output"></div>
    </div>

</div>

<script>
    // --- NAV ---
    function showSection(num) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`section-${num}`).classList.add('active');
        document.querySelectorAll('.nav-btn')[num-1].classList.add('active');
    }

    // --- PART 1: GRAMMAR ---
    const grammarSets=[{title:"Set 1: Basic",qs:[{t:"I (study) when the lights (go) out.",a1:"was studying",a2:"went",p1:"study",p2:"go"},{t:"She (cook) when she (burn) her hand.",a1:"was cooking",a2:"burnt",p1:"cook",p2:"burn"},{t:"We (sleep) when we (hear) a noise.",a1:"were sleeping",a2:"heard",p1:"sleep",p2:"hear"}]},{title:"Set 2: 'While'",qs:[{t:"While I (walk) home, I (see) a cat.",a1:"was walking",a2:"saw",p1:"walk",p2:"see"},{t:"While they (play), it (start) to rain.",a1:"were playing",a2:"started",p1:"play",p2:"start"},{t:"He (fall) asleep while he (read).",a1:"fell",a2:"was reading",p1:"fall",p2:"read"}]},{title:"Set 3: Background",qs:[{t:"The sun (shine) and birds (sing).",a1:"was shining",a2:"were singing",p1:"shine",p2:"sing"},{t:"People (laugh) and music (play).",a1:"were laughing",a2:"was playing",p1:"laugh",p2:"play"},{t:"It (rain) heavily when we (leave).",a1:"was raining",a2:"left",p1:"rain",p2:"leave"}]},{title:"Set 4: Negative",qs:[{t:"I (not / listen) so I (miss) the bus.",a1:"was not listening",a2:"missed",p1:"not / listen",p2:"miss"},{t:"He (not / watch) so he (crash).",a1:"was not watching",a2:"crashed",p1:"not / watch",p2:"crash"},{t:"They (not / sleep) when Dad (come).",a1:"were not sleeping",a2:"came",p1:"not / sleep",p2:"come"}]},{title:"Set 5: Questions",qs:[{t:"What (you / do) when I (call)?",a1:"were you doing",a2:"called",p1:"you / do",p2:"call"},{t:"Where (he / go) when you (see) him?",a1:"was he going",a2:"saw",p1:"he / go",p2:"see"},{t:"(It / rain) when you (wake) up?",a1:"Was it raining",a2:"woke",p1:"It / rain",p2:"wake"}]},{title:"Set 6: Two Actions",qs:[{t:"I (study) while he (play) games.",a1:"was studying",a2:"was playing",p1:"study",p2:"play"},{t:"Mom (cook) while Dad (clean).",a1:"was cooking",a2:"was cleaning",p1:"cook",p2:"clean"},{t:"We (talk) while we (eat).",a1:"were talking",a2:"were eating",p1:"talk",p2:"eat"}]},{title:"Set 7: Accident",qs:[{t:"The driver (drive) too fast.",a1:"was driving",a2:"",p1:"drive",p2:"BLOCK"},{t:"Suddenly, a dog (run) across road.",a1:"ran",a2:"",p1:"run",p2:"BLOCK"},{t:"He (try) to stop but it (be) too late.",a1:"tried",a2:"was",p1:"try",p2:"be"}]},{title:"Set 8: Mystery",qs:[{t:"We (walk) in the forest.",a1:"were walking",a2:"",p1:"walk",p2:"BLOCK"},{t:"Suddenly, we (hear) a scream.",a1:"heard",a2:"",p1:"hear",p2:"BLOCK"},{t:"My friend (start) to cry.",a1:"started",a2:"",p1:"start",p2:"BLOCK"}]}];
    let gIndex=0;
    function renderGrammar(){const c=document.getElementById('grammar-container');c.innerHTML='';grammarSets.forEach((s,i)=>{let d=document.createElement('div');d.className=`grammar-set ${i===0?'active':''}`;d.id=`g-set-${i}`;let h=`<h3>${s.title}</h3>`;s.qs.forEach((q,j)=>{let l=`<div class="grammar-box"><p>${j+1}. `;let s1=q.t.split('('+q.p1+')');l+=s1[0]+`<input type="text" class="grammar-input" id="g-in-${i}-${j}-1" placeholder="${q.p1}">`;if(q.p2!=="BLOCK"){let s2=s1[1].split('('+q.p2+')');l+=s2[0]+`<input type="text" class="grammar-input" id="g-in-${i}-${j}-2" placeholder="${q.p2}">`+s2[1]}else{l+=s1[1]}l+=`</p></div>`;h+=l});d.innerHTML=h;c.appendChild(d)})}
    function changeGrammarSet(d){document.getElementById(`g-set-${gIndex}`).classList.remove('active');gIndex+=d;if(gIndex<0)gIndex=0;if(gIndex>=grammarSets.length)gIndex=grammarSets.length-1;document.getElementById(`g-set-${gIndex}`).classList.add('active');document.getElementById('g-level-num').innerText=gIndex+1;document.getElementById('g-progress-fill').style.width=`${((gIndex)/7)*100}%`;document.getElementById('g-prev-btn').disabled=(gIndex===0);document.getElementById('g-next-btn').style.visibility='hidden';document.getElementById('g-check-btn').style.display='block';document.getElementById('grammar-feedback').innerHTML=""}
    function checkGrammarSet(){let s=grammarSets[gIndex],all=true;s.qs.forEach((q,j)=>{let i1=document.getElementById(`g-in-${gIndex}-${j}-1`),v1=i1.value.trim().toLowerCase();if(v1===q.a1.toLowerCase()||(q.a1==="burnt"&&v1==="burned")){i1.classList.add('correct');i1.classList.remove('wrong')}else{i1.classList.add('wrong');i1.classList.remove('correct');all=false}if(q.p2!=="BLOCK"){let i2=document.getElementById(`g-in-${gIndex}-${j}-2`),v2=i2.value.trim().toLowerCase();if(v2===q.a2.toLowerCase()){i2.classList.add('correct');i2.classList.remove('wrong')}else{i2.classList.add('wrong');i2.classList.remove('correct');all=false}}});let fb=document.getElementById('grammar-feedback');if(all){fb.innerHTML="<span class='correct-txt'>üéâ Perfect! Next Level!</span>";document.getElementById('g-check-btn').style.display='none';document.getElementById('g-next-btn').style.visibility='visible';if(gIndex<7)setTimeout(()=>changeGrammarSet(1),1500);else fb.innerHTML="<span class='correct-txt'>üèÜ COMPLETE!</span>"}else{fb.innerHTML="<span class='wrong-txt'>‚ö†Ô∏è Check yellow boxes!</span>"}}

    // --- PART 3: PLOT ---
    const plotData=[
        {title:"Story 1: The Broken Car (ËΩ¶Âùè‰∫Ü)",parts:[{id:1,en:"Sunny day, we were driving to hometown.",cn:"Êô¥Â§©ÔºåÊàë‰ª¨ÂºÄËΩ¶ÂõûËÄÅÂÆ∂„ÄÇ",type:"1"},{id:2,en:"Suddenly, the car broke down and smoke came out.",cn:"Á™ÅÁÑ∂ÔºåËΩ¶Âùè‰∫ÜÔºåÂÜíÁÉü‰∫Ü„ÄÇ",type:"2"},{id:3,en:"We were stuck in the dark forest and felt scared.",cn:"Êàë‰ª¨Ë¢´Âõ∞Âú®ÈªëÊ£ÆÊûóÈáåÔºåÂæàÂÆ≥ÊÄï„ÄÇ",type:"3"},{id:4,en:"Finally, a truck driver helped us fix it.",cn:"ÊúÄÂêéÔºåÂç°ËΩ¶Âè∏Êú∫Â∏ÆÊàë‰ª¨‰øÆÂ•Ω‰∫Ü„ÄÇ",type:"4"}]},
        {title:"Story 2: The Lost Wallet (‰∏¢Â§±ÁöÑÈí±ÂåÖ)",parts:[{id:1,en:"I was walking to school happily.",cn:"ÊàëÂºÄÂøÉÂú∞Ëµ∞ÂéªÂ≠¶Ê†°„ÄÇ",type:"1"},{id:2,en:"I reached into my pocket and realized my wallet was gone.",cn:"ÊàëÊë∏Âè£Ë¢ãÔºåÂèëÁé∞Èí±ÂåÖ‰∏çËßÅ‰∫Ü„ÄÇ",type:"2"},{id:3,en:"I searched everywhere frantically and wanted to cry.",cn:"ÊàëÁñØÁãÇÂú∞Âà∞Â§ÑÊâæÔºåÊÄ•ÂæóÊÉ≥Âì≠„ÄÇ",type:"3"},{id:4,en:"A kind stranger found it and gave it back to me.",cn:"‰∏Ä‰∏™Â•ΩÂøÉÁöÑÈôåÁîü‰∫∫Êç°Âà∞Âπ∂ËøòÁªô‰∫ÜÊàë„ÄÇ",type:"4"}]},
        {title:"Story 3: Cooking Surprise (ÁÉπÈ•™ÊÉäÂñú)",parts:[{id:1,en:"I wanted to bake a cake for my mother.",cn:"ÊàëÊÉ≥ÁªôÂ¶àÂ¶àÁÉ§‰∏™ËõãÁ≥ï„ÄÇ",type:"1"},{id:2,en:"By mistake, I used salt instead of sugar.",cn:"Êàë‰∏çÂ∞èÂøÉÊääÁõêÂΩìÊàê‰∫ÜÁ≥ñ„ÄÇ",type:"2"},{id:3,en:"Mom took a big bite and spit it out immediately.",cn:"Â¶àÂ¶àÂêÉ‰∫Ü‰∏ÄÂ§ßÂè£ÔºåÈ©¨‰∏äÂêê‰∫ÜÂá∫Êù•„ÄÇ",type:"3"},{id:4,en:"We laughed and ordered a pizza instead.",cn:"Êàë‰ª¨Â§ßÁ¨ëÔºåÊîπÁÇπ‰∫ÜÊä´Ëê®„ÄÇ",type:"4"}]},
        {title:"Story 4: The Scary Shadow (ÂèØÊÄïÁöÑÂΩ±Â≠ê)",parts:[{id:1,en:"I was home alone watching TV at night.",cn:"Êôö‰∏äÊàëÁã¨Ëá™Âú®ÂÆ∂ÁúãÁîµËßÜ„ÄÇ",type:"1"},{id:2,en:"Suddenly, I heard a scratching noise at the door.",cn:"Á™ÅÁÑ∂ÔºåÊàëÂê¨Âà∞Èó®Âè£ÊúâÊäìÊå†Â£∞„ÄÇ",type:"2"},{id:3,en:"My heart beat fast as I opened the door slowly.",cn:"ÊàëÊÖ¢ÊÖ¢ÂºÄÈó®ÔºåÂøÉË∑≥ÂæóÂæàÂø´„ÄÇ",type:"3"},{id:4,en:"It was just a cute stray cat looking for food.",cn:"ÂéüÊù•Âè™ÊòØ‰∏ÄÂè™ÊâæÂêÉÁöÑÊµÅÊµ™Áå´„ÄÇ",type:"4"}]},
        {title:"Story 5: Exam Day (ËÄÉËØïÊó•)",parts:[{id:1,en:"I woke up late for my history exam.",cn:"ÊàëÂéÜÂè≤ËÄÉËØïËµ∑Êôö‰∫Ü„ÄÇ",type:"1"},{id:2,en:"Then, the bus broke down on the way to school.",cn:"ÁÑ∂ÂêéÔºåÂ∑¥Â£´Âú®ÂéªÂ≠¶Ê†°ÁöÑË∑Ø‰∏äÂùè‰∫Ü„ÄÇ",type:"2"},{id:3,en:"I ran all the way to school, sweating heavily.",cn:"Êàë‰∏ÄË∑ØË∑ëÂà∞Â≠¶Ê†°ÔºåÊª°Â§¥Â§ßÊ±ó„ÄÇ",type:"3"},{id:4,en:"Luckily, the teacher let me take the exam.",cn:"Âπ∏Â•ΩÔºåËÄÅÂ∏àËÆ©ÊàëÂèÇÂä†‰∫ÜËÄÉËØï„ÄÇ",type:"4"}]},
        {title:"Story 6: The Flood (Ê¥™Ê∞¥)",parts:[{id:1,en:"It had been raining heavily for three days.",cn:"Èõ®Â∑≤Áªè‰∏ã‰∫Ü‰∏âÂ§©‰∫Ü„ÄÇ",type:"1"},{id:2,en:"Water started coming into our living room.",cn:"Ê∞¥ÂºÄÂßãÊµÅËøõÊàë‰ª¨ÁöÑÂÆ¢ÂéÖ„ÄÇ",type:"2"},{id:3,en:"We climbed onto the roof, waiting for help.",cn:"Êàë‰ª¨Áà¨‰∏äÂ±ãÈ°∂Á≠âÂæÖÊïëÊè¥„ÄÇ",type:"3"},{id:4,en:"Finally, a rescue boat came to save us.",cn:"Áªà‰∫éÔºåÊïëÊè¥ËàπÊù•ÊïëÊàë‰ª¨‰∫Ü„ÄÇ",type:"4"}]},
        {title:"Story 7: The Bully (Èú∏Âáå)",parts:[{id:1,en:"Ali was a new student and he was very shy.",cn:"AliÊòØÊñ∞Êù•ÁöÑÂ≠¶ÁîüÔºåÂæàÂÆ≥Áæû„ÄÇ",type:"1"},{id:2,en:"A big boy took his lunch money in the canteen.",cn:"È£üÂ†ÇÈáå‰∏Ä‰∏™Â§ß‰∏™Â≠êÊä¢‰∫Ü‰ªñÁöÑÂçàÈ§êÈí±„ÄÇ",type:"2"},{id:3,en:"I stood up bravely and told the teacher.",cn:"ÊàëÂãáÊï¢Âú∞Á´ôÂá∫Êù•ÂëäËØâ‰∫ÜËÄÅÂ∏à„ÄÇ",type:"3"},{id:4,en:"The bully apologized and we became friends.",cn:"ÈÇ£‰∏™Áî∑ÁîüÈÅìÊ≠â‰∫ÜÔºåÊàë‰ª¨Êàê‰∫ÜÊúãÂèã„ÄÇ",type:"4"}]},
        {title:"Story 8: The Hike (ÂæíÊ≠•)",parts:[{id:1,en:"We went hiking in the jungle last Sunday.",cn:"‰∏äÂë®Êó•Êàë‰ª¨Âéª‰∏õÊûóÂæíÊ≠•„ÄÇ",type:"1"},{id:2,en:"We lost our map and compass.",cn:"Êàë‰ª¨Ë¶Å‰∏¢‰∫ÜÂú∞ÂõæÂíåÊåáÂçóÈíà„ÄÇ",type:"2"},{id:3,en:"The sun went down and we heard wild animals.",cn:"Â§™Èò≥‰∏ãÂ±±‰∫ÜÔºåÊàë‰ª¨Âê¨Âà∞‰∫ÜÈáéÂÖΩÁöÑÂ£∞Èü≥„ÄÇ",type:"3"},{id:4,en:"We saw a light and found the ranger station.",cn:"Êàë‰ª¨ÁúãÂà∞‰∫ÜÁÅØÂÖâÔºåÊâæÂà∞‰∫ÜÊä§ÊûóÁ´ô„ÄÇ",type:"4"}]}
    ];
    let pIndex=0; let currentPlotOrder=[];
    function renderPlotSet(){const c=document.getElementById('plot-container');let s=plotData[pIndex];let sp=[...s.parts].sort(()=>Math.random()-0.5);currentPlotOrder=sp;let h=`<h3>${s.title}</h3>`;sp.forEach((p,i)=>{h+=`<div class="plot-row"><select class="plot-select" id="p-sel-${i}"><option value="0">Choose...</option><option value="1">1. Intro</option><option value="2">2. Problem</option><option value="3">3. Climax</option><option value="4">4. Resolution</option></select><div class="plot-text-group"><span class="plot-en">${p.en}</span><span class="plot-cn">${p.cn}</span></div></div>`});c.innerHTML=h;document.getElementById('p-level-num').innerText=pIndex+1;document.getElementById('p-progress-fill').style.width=`${((pIndex)/7)*100}%`}
    function changePlotSet(d){pIndex+=d;if(pIndex<0)pIndex=0;if(pIndex>=plotData.length)pIndex=plotData.length-1;renderPlotSet();document.getElementById('p-prev-btn').disabled=(pIndex===0);document.getElementById('p-next-btn').style.visibility='hidden';document.getElementById('p-check-btn').style.display='block';document.getElementById('plot-feedback').innerHTML=""}
    function checkPlotSet(){let all=true;currentPlotOrder.forEach((p,i)=>{let s=document.getElementById(`p-sel-${i}`);if(s.value===p.type){s.style.borderColor="#00b894";s.style.backgroundColor="#e3fdf5"}else{s.style.borderColor="#d63031";s.style.backgroundColor="#ffeaa7";all=false}});let fb=document.getElementById('plot-feedback');if(all){fb.innerHTML="<span class='correct-txt'>üìö Great!</span>";document.getElementById('p-check-btn').style.display='none';document.getElementById('p-next-btn').style.visibility='visible';if(pIndex<7)setTimeout(()=>changePlotSet(1),1500);else fb.innerHTML="<span class='correct-txt'>üèÜ MASTER STORYTELLER!</span>"}else{fb.innerHTML="<span class='wrong-txt'>Hint: Check the Chinese!</span>"}}

    // --- PART 4: GUIDED SPIN ---
    const whos = ["A clumsy student (‰∏Ä‰∏™Á¨®ÊâãÁ¨®ËÑöÁöÑÂ≠¶Áîü)", "A brave detective (ÂãáÊï¢ÁöÑ‰æ¶Êé¢)", "A lonely robot (Â≠§Áã¨ÁöÑÊú∫Âô®‰∫∫)", "A group of friends (‰∏ÄÁæ§ÊúãÂèã)"];
    const wheres = ["at an old school (Âú®ÊóßÂ≠¶Ê†°)", "in a dark forest (Âú®ÈªëÊ£ÆÊûó)", "at a busy shopping mall (Âú®ÁπÅÂøôÁöÑÂïÜÂú∫)", "on a deserted island (Âú®ËçíÂ≤õ)"];
    const whats = ["found a mysterious bag (ÂèëÁé∞Á•ûÁßòÂåÖÂåÖ)", "lost their phone (‰∏¢‰∫ÜÊâãÊú∫)", "saw a ghost (ÁúãÂà∞È¨º)", "missed the last bus (ÈîôËøáÊú´Áè≠ËΩ¶)"];
    
    // Store current elements
    let curWho="", curWhere="", curWhat="";

    function spinWheel() {
        let btn = document.querySelector('.spin-btn');
        btn.disabled = true; btn.innerText = "Spinning...";
        document.getElementById('guide-area').style.display = 'none';
        document.getElementById('final-story-output').style.display = 'none';

        let duration = 0;
        let interval = setInterval(() => {
            curWho = whos[Math.floor(Math.random() * whos.length)];
            curWhere = wheres[Math.floor(Math.random() * wheres.length)];
            curWhat = whats[Math.floor(Math.random() * whats.length)];
            
            document.getElementById('slot-who').innerText = curWho;
            document.getElementById('slot-where').innerText = curWhere;
            document.getElementById('slot-what').innerText = curWhat;
            duration++;
            if(duration > 15) {
                clearInterval(interval);
                btn.disabled = false; btn.innerText = "üé∞ SPIN AGAIN";
                showGuide();
            }
        }, 100);
    }

    function showGuide() {
        document.getElementById('guide-area').style.display = 'block';
        // Clean strings for sentence insertion (remove chinese brackets)
        let cleanWho = curWho.split(' (')[0];
        let cleanWhere = curWhere.split(' (')[0];
        let cleanWhat = curWhat.split(' (')[0];

        // Fill fixed parts
        document.getElementById('g-char-set-text').innerText = `${cleanWho} was ${cleanWhere}.`;
        document.getElementById('g-prob-text').innerText = `${cleanWhat}!`;
    }

    function generateFullStory() {
        let weather = document.getElementById('g-weather').value || "the weather was fine";
        let action = document.getElementById('g-action').value || "doing something interesting";
        let feeling = document.getElementById('g-feeling').value || "scared";
        let ending = document.getElementById('g-ending').value || "they went home";
        
        let cleanWho = curWho.split(' (')[0];
        let cleanWhere = curWhere.split(' (')[0];
        let cleanWhat = curWhat.split(' (')[0];

        let story = `MY SHORT STORY\n\n`;
        story += `Last Saturday, ${weather}. ${cleanWho} was ${cleanWhere}.\n\n`;
        story += `They were busy ${action}. It was a normal day.\n\n`;
        story += `Suddenly, ${cleanWhat}! They felt ${feeling}.\n\n`;
        story += `In the end, ${ending}. What an unforgettable day!`;

        let out = document.getElementById('final-story-output');
        out.innerText = story;
        out.style.display = 'block';
    }

    // Init
    renderGrammar();
    renderPlotSet();
</script>

</body>
</html>